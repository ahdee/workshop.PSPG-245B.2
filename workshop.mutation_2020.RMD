---
title: "Workshop Mutation 2019"
author: "Lee and Martell"
date: "February 5, 2019"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# workshop.mutation.2019
In this workshop you will learn about the fundamentals of mutation identification in cancer. 


```{r, include=T, echo=T, message=FALSE, warning=FALSE, fig=TRUE}
# first makes sure packages are installed. 
# install.packages('knitr', repos = c('https://xran.yihui.name', 'https://cran.r-project.org') 
# devtools::install_github("haozhu233/kableExtra")

# second source file 
# output to console instead


library ( cgdsr)
library ( ggplot2)
library(knitr)
library(kableExtra)
library ( dplyr)
source("auxi.R")



# initiate cbioportal 

cbiop = CGDS("http://www.cbioportal.org/")
```

# Lets learn how communicate with cbioportal and study what is available.

```{r }

# Get list of cancer studies at server
studies = getCancerStudies(cbiop)

# lets take a look at it. 
k2( head ( studies, 10) , "example list of data available in cbioportal")

# ? what do you think each column represents
# ? how do you think we can use this to look for our dataset
# ? what is the "10" for in the function. 

# lets find how many unique sets are in here 
dim ( studies )

# ? How many studies are there currently in cbioportal

# Find the dataset you want. 
# According to the syllabus we are looking for TCGA study on Breast Invasive Carcinoma (TCGA, Cell 2015) 
# ? How do you think we can locate this based on what we know above  
# so lets search for it using the grepl function 


breast = studies[ grepl("Breast", studies$name, ignore.case = T ), ]
# ? what is the T for what if you use lower case instead of upper case

k2(breast, "list of breast related studies")

### First BONUS question! try to find if there are other cancer data you might interested in, eg Lung Cancer

# from the table we now know that the study brca_tcga_pub2015 is what we need

brca.study = "brca_tcga_pub2015"

# note: each institution has different ways of organizing their data, thus its up 
# to the user to find out. As you can see the main node appears to be cancer_study_id
# from here we are going to drill down to caese, that is types of modality and samples available. 

# now that we have a case id we can search to see what types of samples are available AND types of data 

mycaselist = getCaseLists(cbiop,brca.study)
# first lets study what is in the case list.  
k2 ( head ( mycaselist[ ,c("case_list_id",	 "case_list_name",	 "case_list_description",	 "cancer_study_id"	)], 50), "list of cases for the BRCA CELL 2015 study" ) 

# ? can you tell us what each of the column mean based on what is outputed? 
# ? Which data do you think is most relevant this workshop? 


# here we see that brca_tcga_pub2015_3way_complete is probably the best to use because it includes all Complete Tumors vs something like All tumor samples with methylation data sinc we don't care about methylation in this exercise
# ? what would happen if we chose to use "All samples with methylation data" instead

case.list.id = "brca_tcga_pub2015_all"


# ok now using All Complete Tumors lets see if your sample is present. 

mysample = mycaselist[ mycaselist$case_list_id == case.list.id, ]$case_ids
mysample = unlist ( strsplit(mysample, " ") )

# ? mysample variable now contains all the TCGA samples in this study, can you check if your sample is exists? 

# here is the list of samples. Do you see your sample in here? 

samples

# here I chose a sample to test 

myid = "TCGA-C8-A131-01"
mysample[mysample== myid]

# here is another way
intersect ( mysample, myid)

mysample[grepl(myid, mysample)]

### Now lets check if it matches with what is reported: 817 
length ( mysample)

myclinicaldata = getClinicalData(cbiop,getCaseLists(cbiop,brca.study)[1,1])

### Bonus how would you figure out which of these samples are Triple-negative breast tumors. 
# hint look at the caselist and work backwards using the intersect function


# Now lets see what information is available for your study 
mygeneticprofile = getGeneticProfiles(cbiop,brca.study)
k2 ( mygeneticprofile, "types of data available for chosen case" )


# so looking at that we now know it contains several interesting modalities.  Lets try the mutation
mutation = mygeneticprofile[8, 1]
# ? what does [11, 1] mean
mygeneticprofile[grepl( "Mutation", mygeneticprofile$genetic_profile_name), ]

# ? what other modalities do you think may be of interest
# anyone want to guess what "probe most anti-correlated with expression means"
cna = mygeneticprofile[grepl( "HM450", mygeneticprofile$genetic_profile_name),1 ]

exp = mygeneticprofile[grepl( "V2 RSEM", mygeneticprofile$genetic_profile_name),1 ]

```



# Now that we have a basic understanding of what is available lets go and download the actual data. 

```{r}

# lets collect this through a loop so not to overwhelm the system
# its important to be mindful of resources when mining data.  We need to play nice and consider the server load. 
# ? what do you think we can do to miminize server load? 
# cancer.gene was previosly imported so that we are only going to look for gens asscoated with cancer. This is from various sources 
length ( cancer.gene)

total = ceiling ( length( cancer.gene)/100  )  *100
mutations = data.frame (   stringsAsFactors = F )
e = 1
for(i in seq(from=200, to=total, by=200)){
   
    if ( i > length(cancer.gene)){
        i = length(cancer.gene)
    }
    
    print ( paste ( e, i ))
    temp = getMutationData(cbiop , brca.study, mutation, cancer.gene[e:i])
    exp.temp = getProfileData(cbiop , cancer.gene[e:i]
                              , exp
                              , getCaseLists(cbiop,brca.study)[1,1] , samples)
    e = i + 1
    mutations = rbind ( mutations, temp)
    
    Sys.sleep (2) # lets give the system a break
    
}
# create coordinates
mutations$igv = paste ( mutations$chr, mutations$start_position, mutations$end_position, mutations$reference_allele, mutations$variant_allele)

# there is an error in the mutation table.  The links are obsolete.  Here we fix it. 
# by replacing the older url with this: http://mutationassessor.org/r3

mutations$xvar_link = gsub('getma.org','http://mutationassessor.org/r3', mutations$xvar_link)
mutations$xvar_link_msa = gsub('getma.org','http://mutationassessor.org/r3', mutations$xvar_link_msa )
mutations$xvar_link_pdb = gsub('getma.org','http://mutationassessor.org/r3', mutations$xvar_link_pdb  )




```

# lets study the mutation table

```{r}

dim ( mutations )

# lets take a few minutes here to go over the different fields. 
names ( mutations )
?getMutationData

unique( mutations$mutation_type)
# ? based on the lecture previously can identify the different mutation_type
# ? based on the lecture previously can you figure out what each of these mean?  
# for example which of these is a nonsynonymous substitution
# ? for druggability which one of these do you think its more likely to be useful



# ? can you guess what is functional_impact_score
k2 ( data.frame ( table ( mutations$functional_impact_score)  ), "impact scores " )

# Bonus make sure that your sample has mutations. 

nrow ( mutations [ mutations$case_id ==  myid , ] )

# ? if you have more than one sample, say you want to check all 10 samples in the class, how would you do this? 

# ? this is important, for example previously we were able to subset for Triple-negative breast tumors

samples

final =  mutations [ mutations$case_id %in% samples, ]
unique ( final$case_id)

# so as you can see above there are a total of 10 unique samples. 

# lets clear up junk 
gc()
                          

```


# Now lets talk a bit about how to identify pathogenic mutations. 
## Can you recall some of the things that were mentioned previously? 

```{r}

# One easy approach is to look for "cancer" related genes that had already been implicated in cancer.
# ? how do you think we can do that? 

k2 ( cancer.list[17:25, ], "cancer list")

# ? can you recall what is exome sequencing and why its important?

# lets check this list to make sure genes that are relevant to breast cancer exists 

imp = as.character ( cancer.list[grepl("^BRCA|^ATM$|^BARD1$|^CDH1$|^CHEK2$|^NBN$|^NF1$|^PALB2$|^PTEN$", cancer.list$gene), ]$gene )

# ? why did we add ^ in front and $ for only some genes and not others?

k2 ( cancer.list[cancer.list$gene %in% imp, ], "breast cancer genes")

# ? based on this which panel do you think is weakest for breast cancer and why do you think that is the case? 

# Bonus: can you check if BRCA is present in any of the mutations we just downloaded? 

k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol), ] ), "BRCA gene mutations" )


# lets see how many genes do we have all together 
nrow ( cancer.list )

### BONUS can you check if your favorite gene is in here? 

# Another way we can detect important mutations is to see if other resources are available. # Here we use cosmic a manaully curated list of recurrent mutations in cancer. 

k2 ( head ( cosmic.70[ grepl("breast",  cosmic.70$description ), ] ), "breast cancer in cosmic")
# ? what do you think the 70 means?


# lets integrate cosmic into our mutation table

mutations = merge ( mutations, cosmic.70, by="igv", all.x=T, all.y=F )

# ? why do you think all.x = T and all.y=F 

# let us find out how many mutations we have that is also found in cosmic 

nrow ( mutations[ ! is.na ( mutations$description ),  ] ) / nrow (mutations)

# ? wow thats a huge ratio , why do think the ratio is so high? 

# BONUS check if cosmic contain BRCA mutations.  This is a good sanity check. 

k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol), c("amino_acid_change","chr.x","start_position","end_position","reference_allele", "variant_allele",
"gene_symbol","case_id","mutation_status","mutation_type","description")] ) )
# BONUS go to https://cancer.sanger.ac.uk/cosmic and compare results of line 4 
# https://cancer.sanger.ac.uk/cosmic/search?q=3813722
# ? does everything match
# ? why do you think the the coordinates are off by 1


# BONUS can you find all BRCA mutation that is Missense_Mutation AND found is cosmic in the mutation db?


# hint, mutations$mutation_type == "Missense_Mutation"
```

# Now that the data has been succesfully donwloaded lets study your breast cancer set. 

```{r}



# lets tabulate the types of mutations mostly seen with Breast cancer 

mutation.type = data.frame ( table ( mutations$mutation_type))

mutation.type = mutation.type[ order ( mutation.type$Freq), ]

mutation.type$Var1 = factor ( mutation.type$Var1, levels = mutation.type$Var1)

ggplot(mutation.type, aes(Var1,Freq), label=Freq ) +
    geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
    coord_flip() +
    scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
    theme(strip.text.y = element_text(angle = 0), legend.position="none") +
    geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          text = element_text(size=16),  # size of label
          axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "BRCA mutation types")





# ? seems like missense mutation is the most recurrent.  Can you think of any way to clean up the data 

# ? in the lecture we talked about depth.  So lets calculate this. 

mutations$dp = mutations$variant_read_count_tumor + mutations$reference_read_count_tumor 

 ggplot(mutations, aes(x=dp)) + 
  geom_density( color="darkblue", fill="steelblue" ) + geom_vline(xintercept = 20, linetype="dotted", 
                color = "grey", size=1.5) + ggtitle ( " density plot, total depth")

# ? by looking at this plot we can see that there is a good amount of mutations that are under 20 
# ? how would you remove this?

# before  
dim ( mutations )
# after 
mutations = mutations[ mutations$dp > 20, ]
dim (mutations )


# lets calculate allele freqeuncy here as well 
mutations$af = mutations$variant_read_count_tumor / mutations$dp

 ggplot(mutations, aes(x=af)) + 
  geom_density( color="darkblue", fill="#e8975a" ) + geom_vline(xintercept = .1, linetype="dotted", 
                color = "grey", size=1.5) + ggtitle ( " density plot, allele freqeuncy")

# ? what do you think it means when af is higher for a particular mutation 
# Bonus pick the top 10 mutations ranked by af 

mutations = mutations[ order ( - mutations$af ) , ]

k2 ( head ( mutations, 10) , "top 10 variant ranked by AF")

# lets further filter the mutations with any af > .1
mutations = mutations[ mutations$af > .1, ]
dim (mutations)


# plot 20 highest recurrent gene mutations

mutation.gene = data.frame ( table ( mutations$gene_symbol))

mutation.gene = mutation.gene[ order ( - mutation.gene$Freq), ]
mutation.gene$Var1 = factor ( mutation.gene$Var1, levels = rev ( mutation.gene$Var1) )

ggplot(mutation.gene [ 1:20, ] , aes(Var1,Freq), label=Freq ) +
    geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
    coord_flip() +
    scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
    theme(strip.text.y = element_text(angle = 0), legend.position="none") +
    geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          text = element_text(size=16),  # size of label
          axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "Most recurrent genes")


# as mentioned previously one reliable way to look for relevant mutations is to match it against what has been previosly observed and/or study. 

cosmic.mutation = mutations [ !is.na(mutations$description), ]

mutation.type = data.frame ( table ( cosmic.mutation$mutation_type))

mutation.type = mutation.type[ order ( mutation.type$Freq), ]
mutation.type$Var1 = factor ( mutation.type$Var1, levels = mutation.type$Var1)

ggplot(mutation.type, aes(Var1,Freq), label=Freq ) +
    geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
    coord_flip() +
    scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
    theme(strip.text.y = element_text(angle = 0), legend.position="none") +
    geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          text = element_text(size=16),  # size of label
          axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "BRCA mutation types found in cosmic")


# ? compare the two plots, did anything change?

# based on literature these are some of the genes involved in breast cancer. 
imp 

# lets study them and see what types of mutations corresponds most with these genes. 

mutation.brca = data.frame ( table ( mutations[ mutations$gene_symbol %in% imp, ] $mutation_type))

mutation.brca = mutation.brca[ order ( mutation.brca$Freq), ]
mutation.brca$Var1 = factor ( mutation.brca$Var1, levels = mutation.brca$Var1)

ggplot(mutation.brca, aes(Var1,Freq), label=Freq ) +
    geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
    coord_flip() +
    scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
    theme(strip.text.y = element_text(angle = 0), legend.position="none") +
    geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          text = element_text(size=16),  # size of label
          axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "Mutation-types in genes associated with breast cancer")

# lets assume that we don't know these genes 
# ? can you think of a way to find them based on what we have? 

# there are many like how we sorted by most frequent above. 
# another is to subset by what has already been observe in cosmic 

imp.brac = data.frame ( table ( mutations[ grepl( "breast", mutations$description), ]$gene_symbol ) )
imp.brac$fraction = imp.brac$Freq / nrow ( mutations)
imp.brac = imp.brac [ order ( -imp.brac$fraction) , ]

k2 ( head ( imp.brac, 10), "top cosmic genes found in breast cancer")

# ? how does this compare to our plot above 

# both analysis seem to show a lot of overlap eg that TP53 and PIK3CA are important.  Lets breakdown the mutation type a bit more for the top 5

top5 = as.character ( imp.brac$Var1[1:5] )
top5 = mutations[ mutations$gene_symbol %in% top5, ]$amino_acid_change
top5 = data.frame ( table ( top5 ) )
top5 = top5 [ order ( - top5$Freq), ]

# quick hack to add url, will not work with *

top5$url = paste0(url,top5$top5)
k2 ( head ( top5, 20), "top 20 recurrent mutations")



# part of studying mutations is look for clinical significance.  One way to do this is to match your mutations to actionable 
# targets


mutations$drug = paste ( mutations$gene_symbol, mutations$amino_acid_change)

action = drug[ drug$match %in% unique ( mutations$drug  ), ]
action.f = c("gene" ,"variant" , "disease", "drugs", "evidence_type", 
             "clinical_significance", "evidence_statement", "evidence_civic_url", "gene_civic_url" , "match"
)
k2 ( head ( action[ ,action.f], 20) ,"example of actionable mutations in the BRCA set" )

# Bonus can you figure out which samples have druggable targets?  
#? look at evidence type. Can yo figure out which of these are diagnostic vs targetable? 

k2 ( head ( action[action$clinical_significance == "Sensitivity/Response" ,action.f], 20) )



```

# HW at this point please use your own TCGA ID, study it using what you learn above.  Assess QC on your sample, study what genes are most common and which if any are targetable. 

```{r}
# here is example where I chose, myid = "TCGA-C8-A131-01"


actionid = drug[ drug$match %in% unique ( mutations[mutations$case_id == myid, ]  $drug  ), ]

actionid = actionid %>% dplyr::group_by(variant) %>%
        dplyr::summarise(
            gene = paste(unique ( gene ), collapse = "," ) ,
            disease = paste(unique ( disease ), collapse = "," ),
            clinical_significance =  paste(unique ( clinical_significance ), collapse = "," ),
            drugs = paste(unique ( drugs ), collapse = "," ) 
            
        ) %>%
        data.frame()

k2( actionid, myid)
 
```

