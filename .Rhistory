x  <- iris[,-5] %>% as.matrix
hc <- x %>% dist %>% hclust
dend <- hc %>% as.dendrogram
# Find special clusters:
clusters <- cutreeDynamic(hc, distM = as.matrix(dist(x)), method = "tree")
# we need to sort them to the order of the dendrogram:
clusters <- clusters[order.dendrogram(dend)]
clusters_numbers <- unique(clusters) - (0 %in% clusters)
n_clusters <- length(clusters_numbers)
library(colorspace)
cols <- rainbow_hcl(n_clusters)
true_species_cols <- rainbow_hcl(3)[as.numeric(iris[,][order.dendrogram(dend),5])]
dend2 <- dend %>%
branches_attr_by_clusters(clusters, values = cols) %>%
color_labels(col =   true_species_cols)
plot(dend2)
clusters <- factor(clusters)
levels(clusters)[-1]  <- cols[-5][c(1,4,2,3)]
# Get the clusters to have proper colors.
# fix the order of the colors to match the branches.
colored_bars(clusters, dend, sort_by_labels_order = FALSE)
install.packages("dynamicTreeCut")
# let's get the clusters
library(dynamicTreeCut)
data(iris)
x  <- iris[,-5] %>% as.matrix
hc <- x %>% dist %>% hclust
dend <- hc %>% as.dendrogram
# Find special clusters:
clusters <- cutreeDynamic(hc, distM = as.matrix(dist(x)), method = "tree")
# we need to sort them to the order of the dendrogram:
clusters <- clusters[order.dendrogram(dend)]
clusters_numbers <- unique(clusters) - (0 %in% clusters)
n_clusters <- length(clusters_numbers)
library(colorspace)
cols <- rainbow_hcl(n_clusters)
true_species_cols <- rainbow_hcl(3)[as.numeric(iris[,][order.dendrogram(dend),5])]
dend2 <- dend %>%
branches_attr_by_clusters(clusters, values = cols) %>%
color_labels(col =   true_species_cols)
plot(dend2)
clusters <- factor(clusters)
levels(clusters)[-1]  <- cols[-5][c(1,4,2,3)]
# Get the clusters to have proper colors.
# fix the order of the colors to match the branches.
colored_bars(clusters, dend, sort_by_labels_order = FALSE)
# let's get the clusters
library(dynamicTreeCut)
data(iris)
x  <- iris[,-5] %>% as.matrix
hc <- x %>% dist %>% hclust
dend <- hc %>% as.dendrogram
# let's get the clusters
library(dynamicTreeCut)
data(iris)
x  <- iris[,-5] %>% as.matrix
library ( dplyr)
data(iris)
x  <- iris[,-5] %>% as.matrix
hc <- x %>% dist %>% hclust
dend <- hc %>% as.dendrogram
# Find special clusters:
clusters <- cutreeDynamic(hc, distM = as.matrix(dist(x)), method = "tree")
# we need to sort them to the order of the dendrogram:
clusters <- clusters[order.dendrogram(dend)]
clusters_numbers <- unique(clusters) - (0 %in% clusters)
n_clusters <- length(clusters_numbers)
library(colorspace)
cols <- rainbow_hcl(n_clusters)
true_species_cols <- rainbow_hcl(3)[as.numeric(iris[,][order.dendrogram(dend),5])]
dend2 <- dend %>%
branches_attr_by_clusters(clusters, values = cols) %>%
color_labels(col =   true_species_cols)
plot(dend2)
clusters <- factor(clusters)
levels(clusters)[-1]  <- cols[-5][c(1,4,2,3)]
# Get the clusters to have proper colors.
# fix the order of the colors to match the branches.
colored_bars(clusters, dend, sort_by_labels_order = FALSE)
# Find special clusters:
clusters <- cutreeDynamic(hc, distM = as.matrix(dist(x)), method = "tree")
# we need to sort them to the order of the dendrogram:
clusters <- clusters[order.dendrogram(dend)]
clusters_numbers <- unique(clusters) - (0 %in% clusters)
n_clusters <- length(clusters_numbers)
library(colorspace)
install.packages("colorspace")
remove.packages(colorspaces)
library(colorspace)
library(chimeraviz)
soapap9 <- system.file(
"extdata",
"./single/ASC42.final.Fusion.specific.for.genes",
package="chimeraviz")
fusions <- import_soapfuse(soapap9, "hg19", 10)
library(chimeraviz)
rm.package(Gviz)
remove.packages(Gviz)
remove.packages("Gviz")
install.packages('https://bioconductor.org/packages/devel/bioc/bin/windows/contrib/3.5/Gviz_1.25.0.zip', repos = NULL, type = "win.binary")
library(chimeraviz)
remove.packages("IRanges")
install.packages('https://bioconductor.org/packages/devel/bioc/bin/windows/contrib/3.5/IRanges_2.15.18.zip', repos = NULL, type = "win.binary")
library(chimeraviz)
library ( IRanges )
library(chimeraviz)
remove.packages("IRanges")
library ( IRanges )
remove.packages("IRanges")
library ( "IRanges")
install.packages('https://bioconductor.org/packages/release/bioc/bin/windows/contrib/3.5/IRanges_2.14.12.zip', repos = NULL, type = "win.binary")
library(chimeraviz)
remove.packages("IRanges")
install.packages('https://bioconductor.org/packages/release/bioc/src/contrib/IRanges_2.14.12.tar.gz', repos = NULL, type = "source")
source("https://bioconductor.org/biocLite.R")
biocLite(c (
"IRanges "
))
install.packages('https://bioconductor.org/packages/release/bioc/src/contrib/IRanges_2.14.12.tar.gz', repos = NULL, type = "source")
install.packages('https://bioconductor.org/packages/release/bioc/src/contrib/IRanges_2.14.12.tar.gz', repos = NULL, type = "source")
?try
g1 = data.frame (
gene = c( "a","a","a","b"),
value = c(1,2,3,5)
)
g1
g1 %>%
group_by(gene) %>%
dplyr::summarize(
median = mn ( value )[1],
mean = mn ( value )[2]
) %>%
data.frame()
library ( dplyr)
library ( dplyr)
mn <- function ( x ){
return  ( c( median(x), mean(x) ))
}
g1 = data.frame (
gene = c( "a","a","a","b"),
value = c(1,2,3,5)
)
g1 %>%
group_by(gene) %>%
dplyr::summarize(
median = mn ( value )[1],
mean = mn ( value )[2]
) %>%
data.frame()
g1 = data.frame (
gene = c( "a","a","a","b"),
value = c(1,200,3,5)
)
g1 %>%
group_by(gene) %>%
dplyr::summarize(
median = mn ( value )[1],
mean = mn ( value )[2]
) %>%
data.frame()
g1 = data.frame (
gene = c( "a","a","a","a","b"),
value = c(1,200,3,5,0)
)
g1 %>%
group_by(gene) %>%
dplyr::summarize(
median = mn ( value )[1],
mean = mn ( value )[2]
) %>%
data.frame()
g1 = data.frame (
gene = c( "a","a","a","a","b"),
value = c(1,200,3,5,0)
)
g1
g1 %>% group_by(gene) %>%
do(data.frame(t(mn(.$value)))) %>%
data.frame()
library ( dplyr)
mn <- function ( x ){
return  ( list ( med=median(x), mn = mean(x) ))
}
g1 = data.frame (
gene = c( "a","a","a","a","b"),
value = c(1,200,3,5,0)
)
g1 %>%
group_by(gene) %>%
dplyr::summarize(
median = mn ( value )[1],
mean = mn ( value )[2]
) %>%
data.frame()
g1 %>% group_by(gene) %>%
do(data.frame(t(mn(.$value)))) %>%
data.frame()
library(httr)
library(jsonlite)
library(xml2)
library(biomaRt)
# define biomart object
mart <- biomaRt::useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
t2g <- biomaRt::getBM(attributes = c("ensembl_transcript_id", "ensembl_gene_id", "entrezgene",
"external_gene_name","ensembl_peptide_id"), mart = mart)
head ( t2g )
t2g[t2g$external_gene_name == "DUSP2", ]
pr = t2g[t2g$external_gene_name == "DUSP2", ]$ensembl_peptide_id
pr = unique ( pr )
aa = "301..301"
ext <- paste0( "/map/translation/",ENSP00000288943,"/",aa,"?")
ext <- paste0( "/map/translation/",pr,"/",aa,"?")
ext
pr
pr = unique ( pr[1] )
pr
ext <- paste0( "/map/translation/",pr,"/",aa,"?")
ext
r <- GET(paste(server, ext, sep = ""), content_type("application/json"))
stop_for_status(r)
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
head(fromJSON(toJSON(content(r))))
server <- "https://rest.ensembl.org"
ext <- paste0( "/map/translation/",pr,"/",aa,"?")
r <- GET(paste(server, ext, sep = ""), content_type("application/json"))
stop_for_status(r)
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
head(fromJSON(toJSON(content(r))))
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
fromJSON(toJSON(content(r)))
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
df = data.frame ( fromJSON(toJSON(content(r))) )
df
gene = "CHD2"
aa = "721..721"
pr = t2g[t2g$external_gene_name == gene, ]$ensembl_peptide_id
pr = unique ( pr[1] )
server <- "https://rest.ensembl.org"
ext <- paste0( "/map/translation/",pr,"/",aa,"?")
r <- GET(paste(server, ext, sep = ""), content_type("application/json"))
stop_for_status(r)
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
df = data.frame ( fromJSON(toJSON(content(r))) )
df
gene = "PTPRD"
aa = "1023..1023"
pr = t2g[t2g$external_gene_name == gene, ]$ensembl_peptide_id
pr = unique ( pr[1] )
server <- "https://rest.ensembl.org"
ext <- paste0( "/map/translation/",pr,"/",aa,"?")
r <- GET(paste(server, ext, sep = ""), content_type("application/json"))
stop_for_status(r)
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
df = data.frame ( fromJSON(toJSON(content(r))) )
df
gene = "TP53"
aa = "175..175"
pr = t2g[t2g$external_gene_name == gene, ]$ensembl_peptide_id
pr = unique ( pr[1] )
server <- "https://rest.ensembl.org"
ext <- paste0( "/map/translation/",pr,"/",aa,"?")
r <- GET(paste(server, ext, sep = ""), content_type("application/json"))
stop_for_status(r)
# use this if you get a simple nested list back, otherwise inspect its structure
# head(data.frame(t(sapply(content(r),c))))
df = data.frame ( fromJSON(toJSON(content(r))) )
# its difficult to tell exactly if end or start so roughly 3 bp
df$mappings.start
df$mappings.end
df$mappings.seq_region_name # this is the chr
x <- list("a" = 2.5, "b" = TRUE, "c" = 1:3)
x[["a"]]
y <- list("a1" = 2.5, "b1" = TRUE, "c1" = 1:3)
x = list ( y, x )
x
x[["a"]]
x <- list("a" = 2.5, "b" = TRUE, "c" = 1:3)
y <- list("a1" = 2.5, "b1" = TRUE, "c1" = 1:3)
x = c ( y, x )
x
x[["a"]]
head ( action )
library ( cgdsr)
library ( ggplot2)
library(knitr)
library(kableExtra)
library ( dplyr)
source("auxi.R")
setwd("C:/Users/User/Dropbox/git.hub.stuff/asc.lab/Lectures.workshops.tutorials/workshop.mutation.2019")
setwd("C:/Users/User/Dropbox/git.hub.stuff/asc.lab/Lectures.workshops.tutorials/workshop.mutation.2019")
library ( cgdsr)
library ( ggplot2)
library(knitr)
library(kableExtra)
library ( dplyr)
source("auxi.R")
# initiate cbioportal
cbiop = CGDS("http://www.cbioportal.org/")
studies = getCancerStudies(cbiop)
# lets take a look at it.
k2( head ( studies, 10) , "example list of data available in cbioportal")
dim ( studies )
breast = studies[ grepl("Breast", studies$name, ignore.case = T ), ]
# ? what is the T for what if you use lower case instead of upper case
k2(breast, "list of breast related studies")
brca.study = "brca_tcga_pub2015"
mycaselist = getCaseLists(cbiop,brca.study)
k2 ( head ( mycaselist[ ,c("case_list_id",	 "case_list_name",	 "case_list_description",	 "cancer_study_id"	)], 50), "list of cases for the BRCA CELL 2015 study" )
case.list.id = "brca_tcga_pub2015_3way_complete"
mysample = mycaselist[ mycaselist$case_list_id == case.list.id, ]$case_ids
mysample
mysample = unlist ( strsplit(mysample, " ") )
mysample
mysample[2]
samples
myid = "TCGA-C8-A131-01"
mysample[mysample== myid]
mysample[mysample== myid]
intersect ( mysample, myid)
samples
str(mysample)
str(mycaselist)
### Now lets check if it matches with what is reported: 816
length ( mysample)
mysample2 = mycaselist[ mycaselist$case_list_id == "brca_tcga_pub2015_trineg", ]$case_ids
mysample2 = unlist ( strsplit(mysample2, " ") )
intersect(mysample, mysample2)
setdiff (mysample, mysample2)
# Now lets see what information is available for your study
mygeneticprofile = getGeneticProfiles(cbiop,brca.study)
k2 ( mygeneticprofile, "types of data available for chosen case" )
mutation = mygeneticprofile[11, 1]
mutation
# ? what does [11, 1] mean
# ? what other modalities do you think may be of interest
cna = mygeneticprofile[3,1]
total = ceiling ( length( cancer.gene)/100  )  *100
mutations = data.frame (   stringsAsFactors = F )
e = 1
for(i in seq(from=200, to=total, by=200)){
if ( i > length(cancer.gene)){
i = length(cancer.gene)
}
print ( paste ( e, i ))
temp = getMutationData(cbiop , brca.study, mutation, cancer.gene[e:i])
e = i + 1
mutations = rbind ( mutations, temp)
Sys.sleep (2) # lets give the system a break
}
mutations$igv = paste ( mutations$chr, mutations$start_position, mutations$end_position, mutations$reference_allele, mutations$variant_allele)
mutations$xvar_link = gsub('getma.org','http://mutationassessor.org/r3', mutations$xvar_link)
mutations$xvar_link_msa = gsub('getma.org','http://mutationassessor.org/r3', mutations$xvar_link_msa )
mutations$xvar_link_pdb = gsub('getma.org','http://mutationassessor.org/r3', mutations$xvar_link_pdb  )
dim ( mutations )
?getMutationData
# lets take a few minutes here to go over the different fields.
names ( mutations )
unique( mutations$mutation_type)
k2 ( data.frame ( table ( mutations$functional_impact_score)  ), "impact scores " )
# ? can you guess what is functional_impact_score
k2 ( data.frame ( table ( mutations$functional_impact_score)  ), "impact scores " )
# Bonus make sure that your sample has mutations.
nrow ( mutations [ mutations$case_id ==  myid , ] )
names ( mutations )
head ( mutations)
samples
final =  mutations [ mutations$case_id %in% samples, ]
unique ( final$case_id)
unique ( final$case_id)
# lets clear up junk
gc()
k2 ( cancer.list[17:25, ], "cancer list")
imp = as.character ( cancer.list[grepl("^BRCA|^ATM$|^BARD1$|^CDH1$|^CHEK2$|^NBN$|^NF1$|^PALB2$|^PTEN$", cancer.list$gene), ]$gene )
k2 ( cancer.list[cancer.list$gene %in% imp, ], "breast cancer genes")
k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol), ] ), "BRCA gene mutations" )
nrow ( cancer.list )
k2 ( head ( cosmic.70[ grepl("breast",  cosmic.70$description ), ] ), "breast cancer in cosmic")
k2 ( head ( cosmic.70[ grepl("breast",  cosmic.70$description ), ] ), "breast cancer in cosmic")
# ? what do you think the 70 means?
k2 ( head ( mutations))
mutations = merge ( mutations, cosmic.70, by="igv", all.x=T, all.y=F )
k2 ( head ( mutations))
nrow ( mutations[ ! is.na ( mutations$description ),  ] ) / nrow (mutations)
k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol), c("chr.x","start_position","end_position","reference_allele", "variant_allele",
"gene_symbol","case_id","mutation_status","mutation_type","description")] ) )
names ( mutations )
k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol), c("amino_acid_change","chr.x","start_position","end_position","reference_allele", "variant_allele",
"gene_symbol","case_id","mutation_status","mutation_type","description")] ) )
head ( mutations )
k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol) & mutations$mutation_type == "Missense_Mutation", ] )
k2 ( head ( mutations[ grepl("^BRCA", mutations$gene_symbol) & mutations$mutation_type == "Missense_Mutation", ] )  )
mutation.type = data.frame ( table ( mutations$mutation_type))
mutation.type
mutation.type = mutation.type[ order ( mutation.type$Freq), ]
mutation.type
mutation.type$Var1 = factor ( mutation.type$Var1, levels = mutation.type$Var1)
ggplot(mutation.type, aes(Var1,Freq), label=Freq ) +
geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
coord_flip() +
scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
theme(strip.text.y = element_text(angle = 0), legend.position="none") +
geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
text = element_text(size=16),  # size of label
axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "BRCA mutation types")
mutations$dp = mutations$variant_read_count_tumor + mutations$reference_read_count_tumor
ggplot(mutations, aes(x=dp)) +
geom_density( color="darkblue", fill="steelblue" ) + geom_vline(xintercept = 20, linetype="dotted",
color = "grey", size=1.5) + ggtitle ( " density plot, total depth")
# before
dim ( mutations )
mutations = mutations[ mutations$dp > 20, ]
dim (mutations )
mutations$af = mutations$variant_read_count_tumor / mutations$dp
ggplot(mutations, aes(x=af)) +
geom_density( color="darkblue", fill="#e8975a" ) + geom_vline(xintercept = .1, linetype="dotted",
color = "grey", size=1.5) + ggtitle ( " density plot, allele freqeuncy")
mutations = mutations[ order ( - mutations$af ) , ]
k2 ( head ( mutations, 10) , "top 10 variant ranked by AF")
mutations = mutations[ mutations$af > .1, ]
dim (mutations)
mutation.gene = data.frame ( table ( mutations$gene_symbol))
mutation.gene = mutation.gene[ order ( - mutation.gene$Freq), ]
mutation.gene$Var1 = factor ( mutation.gene$Var1, levels = rev ( mutation.gene$Var1) )
ggplot(mutation.gene [ 1:20, ] , aes(Var1,Freq), label=Freq ) +
geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
coord_flip() +
scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
theme(strip.text.y = element_text(angle = 0), legend.position="none") +
geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
text = element_text(size=16),  # size of label
axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "Most recurrent genes")
cosmic.mutation = mutations [ !is.na(mutations$description), ]
mutation.type = data.frame ( table ( cosmic.mutation$mutation_type))
mutation.type = mutation.type[ order ( mutation.type$Freq), ]
mutation.type$Var1 = factor ( mutation.type$Var1, levels = mutation.type$Var1)
ggplot(mutation.type, aes(Var1,Freq), label=Freq ) +
geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
coord_flip() +
scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
theme(strip.text.y = element_text(angle = 0), legend.position="none") +
geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
text = element_text(size=16),  # size of label
axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "BRCA mutation types found in cosmic")
# based on literature these are some of the genes involved in breast cancer.
imp
# based on literature these are some of the genes involved in breast cancer.
imp
# lets study them and see what types of mutations corresponds most with these genes.
mutation.brca = data.frame ( table ( mutations[ mutations$gene_symbol %in% imp, ] $mutation_type))
mutation.brca = mutation.brca[ order ( mutation.brca$Freq), ]
mutation.brca$Var1 = factor ( mutation.brca$Var1, levels = mutation.brca$Var1)
ggplot(mutation.brca, aes(Var1,Freq), label=Freq ) +
geom_bar(aes(fill = Freq), stat="identity", position = "dodge") +
coord_flip() +
scale_fill_distiller(palette = "RdBu") + xlab("") + ylab("") +
theme(strip.text.y = element_text(angle = 0), legend.position="none") +
geom_text(aes(label=Freq), position=position_dodge(width=0.9), vjust=.4, hjust = .5, size=5) +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
text = element_text(size=16),  # size of label
axis.text.x = element_text(angle=0, hjust=1) ) + ggtitle ( "Mutation-types in genes associated with breast cancer")
other is to subset by what has already been observe in cosmic
imp.brac = data.frame ( table ( mutations[ grepl( "breast", mutations$description), ]$gene_symbol ) )
imp.brac$fraction = imp.brac$Freq / nrow ( mutations)
imp.brac = imp.brac [ order ( -imp.brac$fraction) , ]
k2 ( head ( imp.brac, 10), "top cosmic genes found in breast cancer")
top5 = as.character ( imp.brac$Var1[1:5] )
top5 = mutations[ mutations$gene_symbol %in% top5, ]$amino_acid_change
top5 = data.frame ( table ( top5 ) )
top5 = top5 [ order ( - top5$Freq), ]
top5$url = paste0(url,top5$top5)
k2 ( head ( top5, 20), "top 20 recurrent mutations")
mutations$drug = paste ( mutations$gene_symbol, mutations$amino_acid_change)
action = drug[ drug$match %in% unique ( mutations$drug  ), ]
action.f = c("gene" ,"variant" , "disease", "drugs", "evidence_type",
"clinical_significance", "evidence_statement", "evidence_civic_url", "gene_civic_url" , "match"
)
k2 ( head ( action[ ,action.f], 20) ,"example of actionable mutations in the BRCA set" )
k2 ( head ( action[action$clinical_significance == "Sensitivity/Response" ,action.f], 20) )
actionid = drug[ drug$match %in% unique ( mutations[mutations$case_id == myid, ]  $drug  ), ]
actionid = actionid %>% dplyr::group_by(variant) %>%
dplyr::summarise(
gene = paste(unique ( gene ), collapse = "," ) ,
disease = paste(unique ( disease ), collapse = "," ),
clinical_significance =  paste(unique ( clinical_significance ), collapse = "," ),
drugs = paste(unique ( drugs ), collapse = "," )
) %>%
data.frame()
k2( actionid, myid)
head ( cosmic )
head ( cosmic.70 )
head ( drug )
